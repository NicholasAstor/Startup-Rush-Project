{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Torneios | Startup Rush</title>
    <link rel="stylesheet" href="{% static 'css/list_tournament.css' %}" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
  </head>
  <body>
    <header class="cabecalho">
      <div class="logo">
        <a href="{% url 'home' %}">
          <i class="fas fa-trophy"></i> Startup Rush
        </a>
      </div>
      <nav>
        <ul>
          <li>
            <a
              href="{% url 'home' %}"
              class="{% if request.path == '/' %}active{% endif %}"
            >
              <i class="fas fa-home"></i> Home
            </a>
          </li>
          <li>
            <a
              href="{% url 'startups_list' %}"
              class="{% if 'startups' in request.path %}active{% endif %}"
            >
              <i class="fas fa-building"></i> Startups
            </a>
          </li>
          <li>
            <a
              href="{% url 'list_tournaments' %}"
              class="{% if 'tournaments' in request.path %}active{% endif %}"
            >
              <i class="fas fa-trophy"></i> Torneios
            </a>
          </li>
          <li>
            <a
              href="#"
              class="{% if 'battles' in request.path %}active{% endif %}"
            >
              <i class="fas fa-fist-raised"></i> Batalhas
            </a>
          </li>
        </ul>
      </nav>
    </header>
    <main class="container">
      <div class="conteudo">
        {% block content %}
        <div class="pagina-torneios">
          <div class="criar-torneio">
            <h2>Criar Novo Torneio</h2>

            <div class="selecionar-quantidade">
              <h3>Número de Startups</h3>
              <div class="opcoes-quantidade">
                <button class="botao-quantidade" data-qty="4">
                  4 Startups
                </button>
                <button class="botao-quantidade" data-qty="6">
                  6 Startups
                </button>
                <button class="botao-quantidade" data-qty="8">
                  8 Startups
                </button>
              </div>
              <p class="info-rounds" id="info-rounds">
                O torneio terá 2 rodadas.
              </p>
            </div>

            <h3>Selecione as Startups Participantes</h3>
            <div class="lista-startups">
              {% for startup in startups %}
              <div class="startups">
                <input
                  type="checkbox"
                  class="check-startups"
                  id="startup-{{ startup.id }}"
                  data-id="{{ startup.id }}"
                />
                <label for="startup-{{ startup.id }}">{{ startup.name }}</label>
              </div>
              {% endfor %}
            </div>

            <p class="selecionadas" id="selecionadas">
              Selecionadas: 0 de 4 necessárias
            </p>

            <button id="criar" class="criar" disabled>Criar Torneio</button>
          </div>

          <div class="painel-torneios">
            <h2>Torneios</h2>

            {% for tournament in tournaments %}
            <div class="card-torneio">
              <div class="header-torneio">
                <h3 class="titulo-torneio">Torneio #{{ tournament.id }}</h3>
                <span class="status-torneio status-{{ tournament.status }}">
                  {{ tournament.get_status_display }}
                </span>
              </div>

              <div class="meta-torneio">
                <span>{{ tournament.qty_startups }} startups</span>
                <span>{{ tournament.qty_rounds }} rodadas</span>
              </div>

              {% if tournament.champion %}
              <p class="campeao-torneio">
                Campeão: {{ tournament.champion.name }}
              </p>
              {% endif %}

              <a href="#" class="detalhes">Ver Detalhes</a>
            </div>
            {% empty %}
            <p>Nenhum torneio criado ainda.</p>
            {% endfor %}
          </div>
        </div>

        <script>
          document.addEventListener("DOMContentLoaded", function () {
            const quantityBtns = document.querySelectorAll(".botao-quantidade");
            const startupCheckboxes =
              document.querySelectorAll(".check-startups");
            const createBtn = document.getElementById("criar");
            const selectionInfo = document.getElementById("selecionadas");
            const roundsInfo = document.getElementById("info-rounds");

            let selectedQty = 4;
            let selectedStartups = [];

            quantityBtns.forEach((btn) => {
              btn.addEventListener("click", function () {
                // Atualizar seleção visual
                quantityBtns.forEach((b) => b.classList.remove("selected"));
                this.classList.add("selected");

                selectedQty = parseInt(this.dataset.qty);

                updateRoundsInfo();
                updateSelectionInfo();
                updateCreateButton();
              });
            });

            startupCheckboxes.forEach((checkbox) => {
              checkbox.addEventListener("change", function () {
                const startupId = parseInt(this.dataset.id);

                if (this.checked) {
                  selectedStartups.push(startupId);
                } else {
                  selectedStartups = selectedStartups.filter(
                    (id) => id !== startupId
                  );
                }

                updateSelectionInfo();
                updateCreateButton();
              });
            });

            function updateRoundsInfo() {
              const rounds = selectedQty === 4 ? 2 : selectedQty === 6 ? 3 : 4;
              roundsInfo.textContent = `O torneio terá ${rounds} rodadas.`;
            }

            function updateSelectionInfo() {
              selectionInfo.textContent = `Selecionadas: ${selectedStartups.length} de ${selectedQty} necessárias`;
            }

            function updateCreateButton() {
              createBtn.disabled = selectedStartups.length !== selectedQty;
            }

            quantityBtns[0].click();

            createBtn.addEventListener("click", async function () {
              createBtn.disabled = true;
              createBtn.textContent = "Criando...";

              try {
                const response = await fetch('{% url "create_tournament" %}', {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}",
                  },
                  body: JSON.stringify({
                    qty_startups: selectedQty,
                    startups: selectedStartups,
                  }),
                });

                const data = await response.json();

                if (data.success) {
                  window.location.reload();
                } else {
                  alert(data.message || "Erro ao criar torneio");
                }
              } catch (error) {
                console.error("Erro:", error);
                alert("Erro ao criar torneio");
              } finally {
                createBtn.disabled = false;
                createBtn.textContent = "Criar Torneio";
              }
            });
          });
        </script>
        {% endblock %}
      </div>
    </main>
  </body>
</html>
